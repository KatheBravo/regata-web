<mat-card>
  <div class="table-header">
    <mat-icon class="header-icon">{{ data.icon || 'add' }}</mat-icon>
    <span class="header-title">{{ data.title || 'Formulario dinámico' }}</span>
  </div>

  <mat-card-content>
    <form [formGroup]="form">

      @for (key of keys; track key) {

      <!-- Campo contraseña con ojo -->
      @if (key === 'password') {
      <mat-form-field appearance="outline" class="field">
        <mat-label>{{ labelMap[key] || key }}</mat-label>
        <input
          matInput
          [type]="passwordVisible ? 'text' : 'password'"
          [formControlName]="key"
          autocomplete="new-password" />

        <button
          matIconButton
          matSuffix
          type="button"
          (click)="togglePasswordVisibility()"
          [attr.aria-label]="'Mostrar u ocultar contraseña'"
          [attr.aria-pressed]="passwordVisible">
          <mat-icon>{{ passwordVisible ? 'visibility_off' : 'visibility'
            }}</mat-icon>
        </button>

        @if (form.get(key)?.hasError('required')) {
        <mat-error>
          {{ labelMap[key] || key }} es obligatorio
        </mat-error>
        }

        @if (form.get(key)?.hasError('minlength')) {
        <mat-error>
          Mínimo {{ form.get(key)?.errors?.['minlength']?.requiredLength }}
          caracteres
        </mat-error>
        }

        @if (form.get(key)?.hasError('email')) {
        <mat-error>
          Ingresa un correo válido
        </mat-error>
        }
      </mat-form-field>
      }

      <!-- Campo color -->
      @if (isColorField(key)) {
      <mat-form-field appearance="outline" class="field">
        <mat-label>{{ labelMap[key] || key }}</mat-label>
        <div
          style="display: flex; align-items: center; gap: 10px; width: 100%;">
          <input
            matInput
            type="color"
            [formControlName]="key"
            style="width: 42px; height: 38px; min-width: 42px; border: none; background: none; cursor: pointer; padding: 0;" />
          <span
            [style.background]="form.get(key)?.value"
            style="display:inline-block;width:32px;height:32px;border-radius:6px;border:1px solid #ccc;vertical-align:middle;">
          </span>
          <span style="font-family: monospace; font-size: 15px;">
            {{ form.get(key)?.value }}
          </span>
        </div>
      </mat-form-field>
      }

      <!-- Campo booleano -->
      @if (isBooleanField(key)) {
      <div class="estado">
        <mat-slide-toggle [formControlName]="key" color="primary">
        </mat-slide-toggle>
        <span>
          {{ form.get(key)?.value ? 'Activo' : 'Inactivo' }}
        </span>
      </div>
      }

      <!-- Resto de campos NO archivo / NO password / NO color / NO boolean -->
      @if (!isFileField(key) && key !== 'password' && !isColorField(key) &&
      !isBooleanField(key)) {
      <mat-form-field appearance="outline" class="field">
        <mat-label>{{ labelMap[key] || key }}</mat-label>

        <!-- Select dinámico -->
        @if (isSelectField(key)) {
        <mat-select [formControlName]="key">
          @if (key === 'company' || key === 'position') {
          @for (opt of selectOptions[key]; track opt.id) {
          <mat-option [value]="opt.id">{{ opt.name }}</mat-option>
          }
          } @else {
          @for (opt of selectOptions[key]; track opt) {
          <mat-option [value]="opt">{{ opt }}</mat-option>
          }
          }
        </mat-select>
        } @else if (isLevelField(key)) {
        <!-- Select para 'level' -->
        <mat-select [formControlName]="key">
          @for (opt of levelOptions; track opt) {
          <mat-option [value]="opt">{{ opt }}</mat-option>
          }
        </mat-select>
        } @else if (isTextarea(key)) {
        <!-- Textarea -->
        <textarea
          matInput
          [formControlName]="key"
          [readonly]="isReadOnly(key)"></textarea>
        } @else {
        <!-- Numérico / texto -->
        <input
          matInput
          [type]="getInputType(key)"
          [formControlName]="key"
          [readonly]="isReadOnly(key)" />
        }

        <!-- ERRORES DINÁMICOS -->
        @if (form.get(key)?.hasError('required')) {
        <mat-error>
          {{ labelMap[key] || key }} es obligatorio
        </mat-error>
        }

        @if (form.get(key)?.hasError('minlength')) {
        <mat-error>
          Mínimo {{ form.get(key)?.errors?.['minlength']?.requiredLength }}
          caracteres
        </mat-error>
        }

        @if (form.get(key)?.hasError('maxlength')) {
        <mat-error>
          Máximo {{ form.get(key)?.errors?.['maxlength']?.requiredLength }}
          caracteres
        </mat-error>
        }

        @if (form.get(key)?.hasError('email')) {
        <mat-error>
          Ingresa un correo válido
        </mat-error>
        }

        @if (form.get(key)?.hasError('pattern')) {
        <mat-error>
          @switch (key) {
          @case ('taxId') {
          <span>
            Debe ser un NIT válido (7 a 10 dígitos, puede incluir guion y dígito
            de verificación).
          </span>
          }
          @case ('phone') {
          <span>
            Debe ser un número de teléfono válido (7 a 10 dígitos).
          </span>
          }
          @case ('website') {
          <span>
            Ingresa una URL válida (opcional).
          </span>
          }
          @case ('documentNumber') {
          <span>
            Debe ser un número entre 7 y 10 dígitos.
          </span>
          }
          @case ('recoveryPhone') {
          <span>
            Debe ser un número de 10 dígitos.
          </span>
          }
          @default {
          <span>Formato inválido</span>
          }
          }
        </mat-error>
        }

        @if (form.get(key)?.hasError('min')) {
        <mat-error>
          Valor mínimo: {{ form.get(key)?.errors?.['min']?.min }}
        </mat-error>
        }

        @if (form.get(key)?.hasError('max')) {
        <mat-error>
          Valor máximo: {{ form.get(key)?.errors?.['max']?.max }}
        </mat-error>
        }
      </mat-form-field>
      }

      <!-- Campo archivo -->
      @if (isFileField(key)) {
      <div class="field file-upload">
        <mat-form-field appearance="outline" class="file-field">
          <mat-label>{{ labelMap[key] || key }}</mat-label>
          <input
            matInput
            [value]="fileNames[key] || ''"
            placeholder="Selecciona un archivo"
            readonly />
          <button
            matIconButton
            matSuffix
            type="button"
            (click)="fileInput?.click()">
            <mat-icon>attach_file</mat-icon>
          </button>
        </mat-form-field>

        <input
          type="file"
          hidden
          #fileInput
          [attr.data-key]="key"
          (change)="onFileChange($event, key)" />
      </div>
      }

      }

    </form>

    <div mat-dialog-actions align="end">
      <button matButton (click)="dialogRef.close()">Cancelar</button>
      <button
        matButton="filled"
        [disabled]="form.invalid"
        (click)="guardar()">
        Guardar
      </button>
    </div>
  </mat-card-content>
</mat-card>
